<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EXIST GAMER — Solo Tournament</title>
<style>
:root{
  --bg:#040405; --panel:#0b0b0c; --muted:#b6a990; --gold:#EFB810; --accent:#FFD873; --danger:#ff3b30;
  --glass:rgba(255,255,255,0.03); --radius:12px; --pad:14px; --maxw:1100px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#040405,#0b0b0c);color:#fff}
.container{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.brand h1{margin:0;color:var(--gold)} .brand p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border-radius:var(--radius);padding:var(--pad);border:1px solid var(--glass);margin-top:12px}
.row{display:grid;grid-template-columns:1fr 380px;gap:14px}
@media(max-width:880px){ .row{grid-template-columns:1fr} }
.small{font-size:13px;color:var(--muted)}
.input, input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-top:6px}
.btn{padding:10px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--gold),var(--accent));color:#101010}
.btn-ghost{background:transparent;color:var(--gold);border:1px solid rgba(255,255,255,0.04)}
.btn-danger{background:var(--danger);color:#fff}
.table-wrap{overflow-x:auto;width:100%;margin-top:8px}
.table-wrap table{width:100%;border-collapse:collapse}
.table-wrap th, .table-wrap td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
.table-wrap td.left{ text-align:left }
.table-wrap th{color:var(--muted);font-weight:700;font-size:13px}
@media (max-width:700px){
  .table-wrap table, .table-wrap thead, .table-wrap tbody, .table-wrap th, .table-wrap td, .table-wrap tr { display:block; }
  .table-wrap thead { display:none; }
  .table-wrap tr { margin:0 0 12px 0;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03); }
  .table-wrap td{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;white-space:normal;border-bottom:none;}
  .table-wrap td[data-label]::before{content:attr(data-label);color:var(--muted);font-weight:700;margin-right:8px;width:45%;text-align:left;}
}
.status-paid{background:#1f4d1f;color:#d1f7d8;padding:6px 8px;border-radius:8px}
.status-pend{background:#3f2b15;color:#f3e8d7;padding:6px 8px;border-radius:8px}
.admin-only{display:none} .hidden{display:none}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <h1>EXIST GAMER</h1>
      <p class="small muted">Solo • Bermuda — Tournament</p>
    </div>
    <div style="text-align:right">
      <div class="small muted">Admin</div>
      <div style="margin-top:8px">
        <button id="unlockAdminBtn" class="btn btn-ghost">Unlock Admin</button>
        <a id="verifyLink" class="btn btn-ghost" href="verify.html">Verify</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <h2 id="titleHeader" style="margin:0;color:var(--gold)">EXIST GAMER — Solo</h2>
        <p id="desc" class="small muted" style="margin-top:8px">Mode: Solo • Map: Bermuda</p>
        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div><div class="small muted">UPI</div><div style="font-weight:800" id="infoUpi">-</div></div>
          <div><div class="small muted">Room</div><div style="font-weight:800" id="infoRoom">Not set</div></div>
          <div><div class="small muted">Slots</div><div style="font-weight:800" id="slotsInfo">0 filled</div></div>
          <div><div class="small muted">Registration</div><div style="font-weight:800" id="regInfo">Open</div></div>
        </div>
      </div>

      <div>
        <div class="card" style="padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="small muted">Entry</div><div style="font-weight:800" id="feeInfo">₹25</div></div>
            <div><div class="small muted">Per Kill</div><div style="font-weight:800" id="pkill">₹6</div></div>
          </div>
          <div style="height:10px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="payRegBtn" class="btn btn-primary">Pay & Register</button>
            <button id="openRegBtn" class="btn btn-ghost">Register</button>
          </div>
          <div class="small muted" style="margin-top:8px">Use same device for UPI or unlock admin with PIN.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Register</h3>
      <div class="small muted">Fill details & click Pay & Register — QR will appear for payment.</div>

      <label class="small" style="margin-top:10px">Free Fire Name</label>
      <input id="rName" placeholder="Your in-game name" class="input">

      <label class="small">UID</label>
      <input id="rUid" placeholder="e.g. 123456789" class="input">

      <label class="small">WhatsApp</label>
      <input id="rWp" placeholder="10-digit number" class="input">

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="regNowBtn" class="btn btn-primary">Pay & Register</button>
        <button id="clearRegBtn" class="btn btn-ghost">Clear</button>
      </div>

      <div id="qrArea" class="card hidden" style="margin-top:12px;text-align:center;padding:12px">
        <div class="small muted">Scan QR or click Open UPI</div>
        <img id="qrImg" src="" alt="QR" style="width:220px;border-radius:12px;border:1px solid var(--glass);margin-top:8px">
        <div style="height:8px"></div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button id="openUpiBtn" class="btn btn-primary">Open UPI</button>
          <button id="waProofBtn" class="btn btn-ghost">Send Proof (WhatsApp)</button>
        </div>
        <div class="small muted" style="margin-top:8px">After payment, admin will verify and mark Paid.</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Registered Players</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>Name</th><th>UID</th><th>WhatsApp</th><th>Code</th><th>Status</th><th class="admin-only">Actions</th></tr></thead>
          <tbody id="playersTable"><tr><td colspan="7" class="small muted">No players yet.</td></tr></tbody>
        </table>
      </div>
      <div style="height:10px"></div>
      <div class="small muted">Admin can mark Paid/Verify/Delete after unlocking.</div>
    </div>
  </div>

  <div class="card admin-only" id="adminPanel" style="margin-top:16px;display:none">
    <h3 style="margin:0 0 8px 0">Admin Panel</h3>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label class="small">Tournament Name</label><input id="setName" class="input"></div>
      <div><label class="small">Map</label><input id="setMap" class="input"></div>
      <div><label class="small">Entry Fee (₹)</label><input id="setFee" type="number" class="input"></div>
      <div><label class="small">Slots</label><input id="setSlots" type="number" class="input"></div>
      <div><label class="small">Winner1 (₹)</label><input id="setP1" type="number" class="input"></div>
      <div><label class="small">Winner2 (₹)</label><input id="setP2" type="number" class="input"></div>
      <div><label class="small">Winner3 (₹)</label><input id="setP3" type="number" class="input"></div>
      <div><label class="small">Per Kill (₹)</label><input id="setKill" type="number" class="input"></div>
      <div><label class="small">UPI ID</label><input id="setUpi" class="input" placeholder="9170856377-3@ybl"></div>
      <div><label class="small">Registration</label><select id="setReg" class="input"><option value="1">Open</option><option value="0">Closed</option></select></div>
      <div><label class="small">Room ID</label><input id="setRoomId" class="input"></div>
      <div><label class="small">Room Password</label><input id="setRoomPass" class="input"></div>
      <div><label class="small">Admin PIN</label><input id="setAdminPin" class="input" placeholder="786786"></div>
      <div><label class="small">QR File (opt)</label><input id="setQrFile" class="input" placeholder="leave empty to auto-gen"></div>
    </div>

    <div style="height:12px"></div>
    <div style="display:flex;gap:8px">
      <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
      <button id="importSampleBtn" class="btn btn-ghost">Import Sample</button>
      <button id="clearPlayersBtn" class="btn btn-danger">Clear Players</button>
    </div>
    <div class="small muted" style="margin-top:8px">Visible after unlocking with PIN or by opening URL with <code>?admin=1</code>.</div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ---------- FIREBASE CONFIG: change if you use different project ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBh3Bu4R28g93x32DXW_-OIrscbqjIrT4k",
  authDomain: "exist-gamer.firebaseapp.com",
  databaseURL: "https://exist-gamer-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "exist-gamer",
  storageBucket: "exist-gamer.firebasestorage.app",
  messagingSenderId: "868288388784",
  appId: "1:868288388784:web:b4a8b933ccbeb95b392575",
  measurementId: "G-BNFXCZQTJW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- defaults & state ---------- */
const DEFAULTS = {
  name: "EXIST GAMER", map: "Bermuda", fee:25, slots:48,
  p1:150,p2:100,p3:50,perKill:6,upi:"9170856377-3@ybl",
  regOpen:1,roomId:"",roomPass:"",adminPin:"786786",qrFile:""
};
let settings = {...DEFAULTS};
let players = {}; let isAdmin = false;
const playersTable = document.getElementById('playersTable');

/* ---------- UI refs ---------- */
const rName = document.getElementById('rName'), rUid = document.getElementById('rUid'), rWp = document.getElementById('rWp');
const regNowBtn = document.getElementById('regNowBtn'), payRegBtn = document.getElementById('payRegBtn'), clearRegBtn = document.getElementById('clearRegBtn');
const qrArea = document.getElementById('qrArea'), qrImg = document.getElementById('qrImg'), openUpiBtn = document.getElementById('openUpiBtn'), waProofBtn = document.getElementById('waProofBtn');
const unlockAdminBtn = document.getElementById('unlockAdminBtn'), adminPanel = document.getElementById('adminPanel');

const setName = document.getElementById('setName'), setMap = document.getElementById('setMap'), setFee = document.getElementById('setFee'), setSlots = document.getElementById('setSlots');
const setP1 = document.getElementById('setP1'), setP2 = document.getElementById('setP2'), setP3 = document.getElementById('setP3'), setKill = document.getElementById('setKill');
const setUpi = document.getElementById('setUpi'), setReg = document.getElementById('setReg'), setRoomId = document.getElementById('setRoomId'), setRoomPass = document.getElementById('setRoomPass');
const setAdminPin = document.getElementById('setAdminPin'), setQrFile = document.getElementById('setQrFile');
const saveSettingsBtn = document.getElementById('saveSettingsBtn'), importSampleBtn = document.getElementById('importSampleBtn'), clearPlayersBtn = document.getElementById('clearPlayersBtn');

function genCode(){ return (Date.now().toString(36).slice(-4) + Math.random().toString(36).slice(2,5)).toUpperCase(); }

/* ---------- init ---------- */
(function init(){
  db.ref('settings').on('value', snap => {
    const s = snap.val();
    settings = {...DEFAULTS, ...(s||{})};
    applySettings();
  });
  db.ref('players').on('value', snap => {
    players = snap.val() || {};
    renderPlayers();
    document.getElementById('slotsInfo').textContent = `Slots: ${settings.slots} • Filled: ${Object.keys(players).length}`;
  });

  // attach handlers
  payRegBtn && payRegBtn.addEventListener('click', ()=> openQrArea());
  regNowBtn && regNowBtn.addEventListener('click', regNow);
  clearRegBtn && clearRegBtn.addEventListener('click', clearRegForm);
  unlockAdminBtn && unlockAdminBtn.addEventListener('click', unlockAdmin);
  openUpiBtn && openUpiBtn.addEventListener('click', openUPI);
  waProofBtn && waProofBtn.addEventListener('click', sendWhatsAppProof);
  saveSettingsBtn && saveSettingsBtn.addEventListener('click', saveSettings);
  importSampleBtn && importSampleBtn.addEventListener('click', importSample);
  clearPlayersBtn && clearPlayersBtn.addEventListener('click', clearAllPlayers);

  if(location.search.includes('admin=1')) { isAdmin=true; showAdminUI(); }
})();

/* ---------- UI functions ---------- */
function applySettings(){
  document.getElementById('titleHeader').textContent = `${settings.name} — Solo`;
  document.getElementById('desc').textContent = `Mode: Solo • Map: ${settings.map} • Prizes: ${settings.p1}/${settings.p2}/${settings.p3}`;
  document.getElementById('infoUpi').textContent = settings.upi || DEFAULTS.upi;
  document.getElementById('feeInfo').textContent = `₹${settings.fee}`;
  document.getElementById('pkill') && (document.getElementById('pkill').textContent = `₹${settings.perKill}`);
  document.getElementById('regInfo').textContent = settings.regOpen ? "Open" : "Closed";
  document.getElementById('infoRoom').textContent = settings.roomId ? `${settings.roomId} (${settings.roomPass ? "set":"no pass"})` : "Not set";
  if(isAdmin) fillAdminInputs();
}
function fillAdminInputs(){
  setName.value = settings.name || "";
  setMap.value = settings.map || "";
  setFee.value = settings.fee || "";
  setSlots.value = settings.slots || "";
  setP1.value = settings.p1 || "";
  setP2.value = settings.p2 || "";
  setP3.value = settings.p3 || "";
  setKill.value = settings.perKill || "";
  setUpi.value = settings.upi || "";
  setReg.value = settings.regOpen ? "1" : "0";
  setRoomId.value = settings.roomId || "";
  setRoomPass.value = settings.roomPass || "";
  setAdminPin.value = settings.adminPin || "";
  setQrFile.value = settings.qrFile || "";
}

/* ---------- players render ---------- */
function escapeHtml(s){ return (''+s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function hideValue(s){ s=(s||'')+''; if(!s) return ''; return s.length<=4 ? '•••'+s : '•••'+s.slice(-4); }

function renderPlayers(){
  const arr = Object.entries(players||{});
  if(arr.length===0){ playersTable.innerHTML = '<tr><td colspan="7" class="small muted">No players yet.</td></tr>'; return; }
  let html='';
  arr.forEach(([k,p],i)=>{
    const name = escapeHtml(p.name||'');
    const uid = hideValue(p.uid);
    const wp = hideValue(p.wp);
    const code = escapeHtml(p.code||'');
    const status = p.paid ? '<span class="status-paid">Paid</span>' : '<span class="status-pend">Pending</span>';
    const actions = isAdmin ? `<div style="display:flex;gap:6px;justify-content:center">
      <button class="btn btn-primary" onclick="markPaid('${k}')">Paid</button>
      <button class="btn btn-ghost" onclick="markVerified('${k}')">Verify</button>
      <button class="btn btn-ghost" onclick="viewPlayer('${k}')">View</button>
      <button class="btn btn-danger" onclick="deletePlayer('${k}')">Delete</button>
    </div>` : '<div class="small muted">View only</div>';
    html += `<tr><td>${i+1}</td><td class="left">${name}</td><td>${uid}</td><td>${wp}</td><td><b>${code}</b></td><td>${status}</td><td class="admin-only">${actions}</td></tr>`;
  });
  playersTable.innerHTML = html;
}

/* ---------- registration ---------- */
function openQrArea(){ qrArea.classList.toggle('hidden'); qrArea.scrollIntoView({behavior:'smooth'}); }
function clearRegForm(){ rName.value=''; rUid.value=''; rWp.value=''; }

async function regNow(){
  if(!settings.regOpen) return alert('Registration closed by admin.');
  const name = (rName.value||'').trim(), uid = (rUid.value||'').trim(), wp = (rWp.value||'').trim();
  if(!name || !uid || !wp) return alert('Please fill all fields.');
  if(wp.length < 8) return alert('Enter valid WhatsApp number.');

  const code = genCode();
  const payload = { name, uid, wp, code, paid:0, verified:0, createdAt: Date.now() };
  try{
    await db.ref('players').push(payload);
    alert('Registered! Your code: ' + code + '. Save it.');

    // UPI deep link with code in note
    const upi = settings.upi || DEFAULTS.upi;
    const amount = settings.fee || DEFAULTS.fee;
    const tn = 'Entry:' + code;
    const upiLink = `upi://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent(settings.name||DEFAULTS.name)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(tn)}`;
    const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent(upiLink)}`;

    if(qrImg) qrImg.src = qrUrl;
    if(qrArea) qrArea.classList.remove('hidden');
    qrArea.scrollIntoView({behavior:'smooth'});

    // wire openUpi to same link
    if(openUpiBtn){
      openUpiBtn.onclick = function(){
        try{
          const intent = `intent://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent(settings.name||DEFAULTS.name)}&am=${encodeURIComponent(amount)}&cu=INR#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`;
          window.location.href = intent;
          setTimeout(()=>{ window.location.href = upiLink; }, 1200);
        }catch(e){
          window.location.href = upiLink;
        }
      };
    }

    // wire WhatsApp proof
    if(waProofBtn){
      waProofBtn.onclick = function(){
        const adminNum = (settings.adminNum||'').replace(/\D/g,'') || '9170856377';
        const msg = `I have paid for ${settings.name||DEFAULTS.name}. Code: ${code}. Please verify.`;
        const wa = `https://wa.me/${adminNum}?text=${encodeURIComponent(msg)}`;
        window.open(wa,'_blank');
      };
    }

    clearRegForm();
  }catch(e){
    console.error('reg error', e);
    alert('Registration failed. Check console.');
  }
}

/* ---------- UPI helpers ---------- */
function openUPI(){
  const upi = settings.upi || DEFAULTS.upi;
  const amount = settings.fee || DEFAULTS.fee;
  const intent = `intent://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent(settings.name||DEFAULTS.name)}&am=${encodeURIComponent(amount)}&cu=INR#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`;
  window.location.href = intent;
  setTimeout(()=>{ window.location.href = `upi://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent(settings.name||DEFAULTS.name)}&am=${encodeURIComponent(amount)}&cu=INR`; },1200);
}
function sendWhatsAppProof(){ /* fallback if clicked before reg */ window.open('https://wa.me/9170856377?text='+encodeURIComponent('I have paid. Code: '),'_blank'); }

/* ---------- admin ---------- */
function showAdminUI(){
  isAdmin = true;
  document.querySelectorAll('.admin-only').forEach(x=>x.style.display='');
  const ap = document.getElementById('adminPanel'); if(ap) ap.style.display='';
  fillAdminInputs();
}
async function unlockAdmin(){
  const pin = prompt('Enter admin PIN:'); if(!pin) return;
  try{
    const snap = await db.ref('settings/adminPin').once('value');
    const real = snap.exists()? snap.val() : DEFAULTS.adminPin;
    if(String(pin)===String(real)){ showAdminUI(); alert('Admin unlocked'); }
    else alert('Wrong PIN');
  }catch(e){
    if(pin===DEFAULTS.adminPin){ showAdminUI(); alert('Admin unlocked (fallback)'); }
    else { console.error(e); alert('Error'); }
    }
}
async function saveSettings(){
  if(!isAdmin) return alert('Admin only');
  const s = {
    name: setName.value.trim()||settings.name,
    map: setMap.value.trim()||settings.map,
    fee: Number(setFee.value)||settings.fee,
    slots: Number(setSlots.value)||settings.slots,
    p1: Number(setP1.value)||settings.p1,
    p2: Number(setP2.value)||settings.p2,
    p3: Number(setP3.value)||settings.p3,
    perKill: Number(setKill.value)||settings.perKill,
    upi: setUpi.value.trim()||settings.upi,
    regOpen: Number(setReg.value),
    roomId: setRoomId.value.trim()||settings.roomId,
    roomPass: setRoomPass.value.trim()||settings.roomPass,
    adminPin: setAdminPin.value.trim()||settings.adminPin,
    qrFile: setQrFile.value.trim()||settings.qrFile
  };
  try{ await db.ref('settings').set(s); alert('Settings saved.'); }catch(e){ console.error(e); alert('Save failed'); }
}

async function importSample(){
  if(!isAdmin) return alert('Admin only');
  const sample = [
    {name:"Inferno", uid:"3889662216", wp:"917000000001", code:"A1B2C3", paid:1, verified:1, createdAt:Date.now()},
    {name:"Action Bolt", uid:"4344524799", wp:"917000000002", code:"D4E5F6", paid:0, verified:0, createdAt:Date.now()}
  ];
  try{ const ref = db.ref('players'); for(const p of sample) await ref.push(p); alert('Sample imported'); }catch(e){ console.error(e); alert('Import failed'); }
}

async function clearAllPlayers(){
  if(!isAdmin) return alert('Admin only');
  if(!confirm('Clear all players?')) return;
  try{ await db.ref('players').set(null); alert('Players cleared'); }catch(e){ console.error(e); alert('Failed'); }
}

/* per-player admin actions */
window.markPaid = async function(key){ if(!isAdmin) return alert('Admin only'); try{ await db.ref('players/'+key).update({paid:1}); }catch(e){ console.error(e); alert('Fail'); } };
window.markVerified = async function(key){ if(!isAdmin) return alert('Admin only'); try{ await db.ref('players/'+key).update({verified:1}); }catch(e){ console.error(e); alert('Fail'); } };
window.deletePlayer = async function(key){ if(!isAdmin) return alert('Admin only'); if(!confirm('Delete player?')) return; try{ await db.ref('players/'+key).remove(); }catch(e){ console.error(e); alert('Fail'); } };
window.viewPlayer = async function(key){ const snap = await db.ref('players/'+key).once('value'); const p = snap.val(); if(!p) return alert('Not found'); alert(`Name: ${p.name}\nUID: ${p.uid}\nWA: ${p.wp}\nCode: ${p.code}\nPaid: ${p.paid? 'Yes':'No'}`); };

/* ---------- misc ---------- */
function applySettings(){ /* kept for compatibility */ }
</script>
</body>
</html>
